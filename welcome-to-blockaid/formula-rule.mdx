---
title: "Formula Detection Rule"
---

Formula Detection Rules let you create custom alerts using mathematical expressions that combine multiple blockchain metrics. Instead of regular detection rules that fire on singular events, you can build detection logic that monitor a metric crossing a threshold or detect complex logic on relationships between different data points.

Think of formula rules as smart calculators for your blockchain data. You can combine different metrics (like token balances and contract values) using mathematical operations to create powerful detection conditions.

**When the formula result i**`true`**, an incident is created with your chosen severity level.**

<Tip>
  **Why Use Formula Rules?**

  - **Complex Logic**: Combine multiple conditions with AND/OR operations
  - **Trend Detection**: Monitor how values change over time periods
  - **Relative Comparisons**: Compare metrics against each other, not just fixed thresholds
  - **Advanced Math**: Use calculations like ratios, percentages, and multipliers
</Tip>

import MySnippet from '/snippets/divider.mdx';

<MySnippet />

# Create a Formula Rule

To create a Formula Detection Rule, follow these steps:

<Accordion title="Step 1: Create a New Rule">
  1. On the Blockaid platform, navigate to **Detection Rules** and then click **Add Detection Rule**.
     The Add Custom Detection Rule window opens.
  2. From the **Choose Detection Logic** section, select the **Formula Rule** logic and click **Next**.
  3. Under the **Configure Rule** section, complete the fields as follows:
     - **Rule Name** - Enter a descriptive name that will help you easily identify the rule in the detection rules list.
     - **Tags** - Add tags that will allow you to organize your environment better.
     - **Incident Name** - Provide the name of the incident that will be created when the rule is met. This name will appear in the Incidents page.
     - **Category** - Determine under which category the incident will be placed when created.
</Accordion>

<Accordion title="Step 2: Define Metrics">
  A metric is the data point you want to monitor as part of your rule. Once the metric meets a pre-determined condition (set up in the Formula section), the rule will trigger and an Incident will be created. For instance, track the volume of a specific token in your wallet and trigger the rule when the volume exceeds 20%.

  Metrics are saved and can be reused across multiple formula rules. Saved metrics can also be edited and adjusted to fit changing needs.

  There are two types of metrics:

  - **Contract Call (EVM)** - Read a numeric value by calling a read-only smart contract function. Common for balances, supply, counters, configuration values.
  - **Read Object (Sui)** - Read a numeric value from a Sui object. This is useful for reading counters and balances stored as Sui object fields.

  <Warning>
    **Note**
    The contract (for Contract Call type) or Sui object (for Object Read type) must already exist in your Inventory as an asset before you can configure and save the metric.
  </Warning>
  **To define metrics:**

  1. Click the **Choose Metric** dropdown and select an existing metric, or click **\+ Add new metric** to create a new one.

     <Tip>
       **Tip**

       If you're selecting an existing metric, skip to the Create Formula section.
     </Tip>
  2. Under the **Configure Metric**, fill in the following:
     1. **Metric Name** - Enter a descriptive name that will help you easily identify the metric in the metrics list.
     2. **Metric Type** - Select the type of metric (Contract Call or Read Object).
     3. Continue based on the selected type:

        <Tabs>
          <Tab title="Contract Call (EVM)">
            Fill-in the fields as follows:
            1. **Target** - Select the contract to read from. This list is based on your Inventory.
            2. **Function** - The function to call from the contract, e.g. `balanceOf(address)` or `totalSupply()`. This list will show only functions that return numeric values.
            3. **Input Parameters** - The arguments to pass to the function. Some functions don't require input parameters.
            4. **Output Field** - Which returned value to use. Only numeric outputs are selectable.

               <Warning>
                 **Note**
                 If the Functions list is empty, the contract you've selected doesn't include functions that return numeric values. To continue, select a different contract.
               </Warning>
          </Tab>
          <Tab title="Read Object (Sui)">
            Fill-in the fields as follows:
            1. **Target** - Select the Sui object to read from. This list is based on your Inventory.
            2. **Field** - The numeric field to extract. Only numeric fields are selectable.
          </Tab>
        </Tabs>
     4. Click **Test Metric** to validate the metric's configuration.
     5. Once the test passed successfully, click **Save Metric**.
     6. Check that your metrics are collecting data correctly and review their values.
     7. Click the Sigma symbol to choose how to process metric data over time periods:
        - **Sum**: Add up all values in the time period
        - **Average**: Calculate the average value
        - **Minimum**: Use the lowest value in the period
        - **Maximum**: Use the highest value in the period

  <Tip>
    Tip

    - You can add more metrics to the rule by clicking **\+ Add Another Metric** and repeating the process.
    - You can edit a saved metric by selecting it from the list and clicking the cogwheel icon.
  </Tip>
</Accordion>

<Accordion title="Step 3: Create a Formula">
  Write the mathematical expression that combines your metrics to detect the conditions you care about. in this step, the previously created metrics are mapped to letters (A, B, C...) for concise expressions.

  In the formula input field, you'll write expressions using:

  - **Letters (A, B, C, etc.)** to represent your metrics
  - **Operators** to combine and compare them
  - **Numbers** for thresholds and calculations

  **Example**: `A > 1000` means "trigger when metric A is greater than 1000"

  <Tip>
    **Tip**

    Click on any point on the metric chart to copy its exact value. You can paste that value into the formula input to quickly set a realistic threshold (e.g., `A > 574000000000000`).
  </Tip>
  **To create a formula:**

  1. In the **fx** field, write a mathematical expression using the metrics configured earlier. You can use the syntax specified below.
  2. From the alert severity dropdown, select the severity of the incident that will be created when the rule is activated:
     - **Critical**: Urgent issues requiring immediate attention
     - **High**: Important issues that need prompt response
     - **Medium**: Notable issues that should be addressed
     - **Low**: Informational alerts for awareness
  3. Click **Save Rule**.
</Accordion>

<MySnippet />

# Formula Syntax

You can use the following syntax in your formula:

<Accordion title="Basic Math">
  | Operator | Meaning        | Example        |
  | -------- | -------------- | -------------- |
  | `+`      | Addition       | `A + B > 100`  |
  | `-`      | Subtraction    | `A - B < 50`   |
  | `*`      | Multiplication | `A * 2 > B`    |
  | `/`      | Division       | `A / B > 1.5`  |
  | `^`      | Power          | `A ^ 2 > 1000` |
</Accordion>

<Accordion title="Comparisons">
  | Operator | Meaning               | Example    |
  | -------- | --------------------- | ---------- |
  | `>`      | Greater than          | `A > 1000` |
  | `<`      | Less than             | `A < 500`  |
  | `>=`     | Greater than or equal | `A >= 100` |
  | `<=`     | Less than or equal    | `A <= 200` |
  | `==`     | Equal to              | `A == 0`   |
  | `!=`     | Not equal to          | `A != 100` |
</Accordion>

<Accordion title="Combining Conditions">
  | Operator | Meaning            | Example              |
  | -------- | ------------------ | -------------------- |
  | `and`    | Both must be true  | `A > 100 and B < 50` |
  | `or`     | Either can be true | `A > 1000 or B == 0` |
</Accordion>

<Accordion title="Time-Based Changes">
  Time-based change operators apply to a single metric at a time. Do not combine two metrics inside the same change operation. Use parentheses when mixing with other operators for clarity.

  | Operator           | Meaning         | Example                          |
  | ------------------ | --------------- | -------------------------------- |
  | `increased_by`     | Value went up   | `(A increased_by 10% in 1h)`     |
  | `decreased_by`     | Value went down | `(A decreased_by 50 in 30m)`     |
  | `net_increased_by` | Net change up   | `(A net_increased_by 2x in 24h)` |
  | `net_decreased_by` | Net change down | `(A net_decreased_by 25% in 2h)` |

  The following are not allowed:

  - `A increased_by B% in 1h` (two metrics in one change operation)
  - `(A + B) increased_by 10% in 1h` (change applies to a single metric only)
</Accordion>

<Accordion title="Ranges">
  `between` Value in range: `A between 10 and 100`
</Accordion>

<Accordion title="Operator Precedence">
  The formula parser respects mathematical precedence rules:

  1. `^` (Exponentiation)
  2. `*`, `/` (Multiplication, Division)
  3. `+`, `-` (Addition, Subtraction)
  4. `<`, `<=`, `>`, `>=`, `increased_by`, `decreased_by`, `net_increased_by`, `net_decreased_by`, `between` (Comparison and Trend)
  5. `==`, `!=` (Equality)
  6. `and` (Logical AND)
  7. `or` (Logical OR)
</Accordion>

<Accordion title="Parentheses">
  ```
  (A \+ B) \* C \> 100
  (A \> 50 and B \< 100) or C == 0
  ```
</Accordion>

# Real-World Examples

## Token Supply Threshold

Alert when an ERC-20 token's `totalSupply()` exceeds a threshold.

```
A > 1_000_000_000_000_000_000_000
```

## Wallet Balance Surge

Alert when the wallet has \>10k tokens AND its balance increased by 50% in the last 30 minutes.

```
A > 10_000 and A increased_by 50% in 30m
```

A: `balanceOf(wallet)` for the token

## Pool Reserve Imbalance

Alert when either reserve is more than 20% larger than the other (checks both directions).

```
(A / B > 1.2) or (B / A > 1.2)
```

- A: `getReserves().reserve0`
- B: `getReserves().reserve1`

Alternative (range check):

```
(A / B < 0.80) or (A / B > 1.2)
```

This triggers when the ratio leaves a healthy band of 0.83–1.2.

## Liquidity Floor

Alert when pool liquidity drops below a floor.

```
A < 5_000_000
```

A: Sui pool object `liquidity` field

## Reserve Utilization

Alert when utilization exceeds 90%.

```
A / B > 0.9
```

- A: Lending pool `totalBorrows()` (or equivalent borrowed amount)
- B: Lending pool `totalSupply()` (or equivalent supplied amount)

# Best Practices

## Working with Time Periods

When using time-based operators like `increased_by`, you need to specify a time period:

### Time Format

Write time as: `{number}{unit}`

| Unit    | Example            |
| ------- | ------------------ |
| seconds | `30s` = 30 seconds |
| minutes | `15m`= 15 minutes  |
| hours   | `12h`= 12 hours    |

### Types of Changes You Can Track

**Absolute numbers:**

Balance went up by exactly 1000 units.

```
balance increased_by 1000 in 1h
```

**Percentages:**

Price went up by 25%.

```
price increased_by 25% in 30m
```

**Multipliers:**

Volume doubled (2 times larger).

```
volume increased_by 2x in 2h
```

<Info>
  **Note**

  Time-based changes apply to a single metric only. Do not reference another metric as the change value.
</Info>

## Tips for Success

<Card title="Start Simple">
  Begin with basic conditions and add complexity gradually:

  ```
  A > 1000
  ```

  Then expand to:

  ```
  A > 1000 and B increased_by 10% in 1h
  ```
</Card>

<Card title="Use Clear Logic">
  Group related conditions with parentheses:

  ```
  (balance > 100000 and volume increased_by 50% in 1h) or emergency_flag == 1
  ```
</Card>

## Common Issues & Solutions

<Accordion title="❌  Unknown metric: X" iconType="regular">
  **Problem**: You're referencing a metric that doesn't exist.

  **Fix**: Make sure all letters (A, B, C, etc.) in your formula have corresponding metrics defined in Step 1.
</Accordion>

<Accordion title="❌ Expression must contain at least one metric">
  **Problem**: Your formula only has numbers, like `5 + 3`.

  **Fix**: Include at least one metric variable: `A + 5 > 10`.
</Accordion>

<Accordion title="❌ Invalid timeframe format">
  **Problem**: Wrong time format in trend operators.

  **Fix**: Use the correct format: `15m`, `2h`, `30s` (not `15 minutes` or `2 hrs`).
</Accordion>

<Accordion title="⚠️ Formula not triggering alerts">
  **Check these:**

  1. Are your metrics collecting data? (Check Step 2: Metric Details)
  2. Are your threshold values realistic for the data range?
  3. Are you using the right time periods for trend analysis?
</Accordion>

<Accordion title="⚠️ Too many false alerts">
  **Try these:**

  1. Increase threshold values to reduce sensitivity
  2. Add additional conditions with `and` to make triggers more specific
  3. Use longer timeframes for trend analysis to reduce noise
</Accordion>